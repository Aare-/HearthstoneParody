<!DOCTYPE HTML>
<html>
<head>
	<title>LD31</title>	
	<link href="css/style.css" rel="stylesheet">
	<link href="css/jquery-ui.css" rel="stylesheet">	
	
	<!-- <script src="libs/pixi.js"></script> -->
	<script src="socket.io/socket.io.js"></script>	
	<script src="libs/jquery.min.js"></script>
	<script src="libs/jquery-ui.min.js"></script>	
</head>
<body>
<div class="modal">		
	<div class="content"></div>
</div>

<div class="templates">
	<div class="card card_create">				
		<img class="minion" src=""/>	
		<div class="card_content">	
			<p class="name">_blank_</p>		


			<div class="card_cost">0</div>
			
			<div class="stats">
				<div class="property life">HP: <p class="value">0</p>
					<button class="add" onclick="increaseHP(this);">+</button>
					<button class="remove" onclick="decreaseHP(this);">-</button>
				</div>

				<div class="property attack">DMG: <p class="value">0</p>
				<button class="add" onclick="increaseDMG(this);">+</button>
				<button class="remove" onclick="decreaseDMG(this);">-</button>
				</div>

				<div class="extra death_rattle">
					<div class="list"></div>
					<button>Add death rattle</button>
				</div>

				<div class="extra behavior">
					<div class="list"></div>
					<button>Add behavior</button>
				</div>

				<div class="extra shout">
					<div class="list"></div>
					<button>Add shout</button>
				</div>

				<div class="extra rage">
					<div class="list"></div>
					<button>Add rage</button>
				</div>
			</div>
		</div>		
	</div>

	<div class="card card_to_ban">
		<img class="minion" src=""/>
		<div class="card_content">	
			<p class="name"></p>		

			<button onclick="banCard(this);">Ban</button>		

			<div class="cost"></div>
			
			<div class="stats">
				<div class="property life">HP: <p class="value"></p></div>
				<div class="property attack">DMG: <p class="value"></p></div>
			</div>
		</div>
	</div>

	<div class="card regular_card">
		<img class="minion" src=""/>
		<div class="card_content">	
			<p class="name"></p>					
			<div class="cost"></div>			
			<div class="stats">
				<div class="property life">HP: <p class="value"></p></div>
				<div class="property attack">DMG: <p class="value"></p></div>
			</div>
		</div>
	</div>

	<div class="yourBannedCards">
		<h2>Your cards banned by the opponent:</h2>
		<div class="card_container">
		</div>
	</div>
</div>

<div class="game">
	<div class="game_screen welcome">	
		<img src="art/welcome.jpg"/>
		<h1>WELCOE TO HEART_OF_STONE BUT WITH REAL PEOPLE INSTEAD</h1>
		<h2>ALSO YOU CAN PLAY WITH ANY CARDS YOU DESIRE</h2>

		<h3>PREPARING THE GAME...</h3>
	</div>

	<div class="game_screen create_deck">
		<div class="header">
			<h1>Create your deck: </h1>
			<h2>Mana points: <p class="total_mana_points"></p></h2>	
			<button onclick="randAllStats();">Randomise</button>			
			<button onclick="searchForGame();">Play</button>		
		</div>
		<div class="card_container"></div>				
	</div>

	<div class="game_screen please_wait">	
		<h1>SEARCHING FOR OPPONENT!</h1>
	</div>

	<div class="game_screen ban_cards">	
		<div class="header">
			<h1>BAN CARDS!</h1>
			<h2>Left to ban: <p class="left_to_ban">0</p></h2>
			<button onclick="readyToPlay();">Ready</button>		
			<h2 class="isOpponentReady">Opponent Ready</h2>
		</div>
		<div class="card_container"></div>
	</div>

	<div class="game_screen starting">
		<h1>Launching game</h1>
		<div class="cardsContainer">

		</div>
	</div>

	<div class="game_screen play_game">	

		<h1>GAMEEEE!!!</h1>
	</div>	
</div>

<script>
//stuff
function shuffle(o){
    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
};

//config
var minionsExtra = 
	[{ name : "death_rattle",
	   arr  : 
			[{id   : "add_lite_opponent", 
			  name : "Add 5 life for opponent", 
			  cost : -2}, 
			 {id   : "change_track_chance", 
			  name : "50% chance to switch track", 			  
			  cost : 1}] 
	 },
	 { name : "behaviour",
	   arr  : 
			[{id   : "double_speed", 
			  name : "Double The Speed", 
			  cost : 2}, 
			 {id   : "change_track_chance", 
			  name : "50% chance to switch track", 
			  chance : 0.5,
			  cost : 1}]
	 },
	 { name : "shout",
	   arr : 
			[{id   : "reverse_order", 
			  name : "Reverse order of ally minions on this track", 
			  cost : 2}, 
			 {id   : "reverse_order_opp", 
			  name : "Reverse order of enemy minions on this track", 		  
			  cost : 2}]
	 },
	 { name : "rage",
	   arr : 
			[{id   : "extra_attack", 
			  name : "Add ", 
			  cost : 2}, 
			 {id   : "heal_line", 
			  name : "If not destroyed heal all ally enemies on track by 2", 		  
			  cost : 2}] }];

var TOTAL_CARDS_NUM = 30;
var BASIC_MANA_PER_CARD = 5;
var TOTAL_MANA_TO_DISTRIBUTE = TOTAL_CARDS_NUM * BASIC_MANA_PER_CARD;
var MAX_STAT = 8;

var totalMana;

var namesArr = ["Gabriel Kochheiser","Logan Fury","Pedro Kotheimer","Gerardo Baydal","Alva Caringi","Thanh Kyhn","Fritz Semmler","Nicholas Kemph","Hosea Sozio","Jackie Tiernan","Ralph Gilespie","Sydney Cabam","Hosea Melaro","Ruben Daschofsky","Saul Whitbeck","Demetrius Knaff","Jerry Spanicek","Eric Yun","Thanh Corria","Ignacio Stryker","Lenard Kishimoto","Dominick Benari","Kraig Valladao","Kasey Giddings","Clayton Buza","Ward Durette","Frederick McGhee","Wesley Millinor","Terrence Wolfrom","Darryl Younger","Tyson Benvenuti","Sebastian Matthis","Zack Wikins","Randall Stonebarger","Edmundo McNamer","Sung Schuch","Pedro Willner","Shelby Haurin","Leif Velovic","Buck Heuberger","Roger Bloss","Carson Laham","Sanford Haraldson","Romeo Schatzberg","Kelly Wims","Mohammed Ladden","Roland Tryon","Harrison Zywiec","Roy Malas","Wilbert Pinto","Erin Eshenbrenner","Vincent Noda","Barrett Ducharme","Alejandro Schoppert","Santos Derita","Jospeh Marsico","Augustine Emuka","Erin Malaney","Ward Washell","Granville Congleton","Tyree Clure","Bart Santangelo","Dalton Drury","Danilo Jarret","Adolph Salzano","Brant Vasbinder","Scottie Zych","Zachary Darsey","Jc Gershen","Bernie Benecke","Lavern McLin","Jerome Braithwaite","Rosendo Adamson","Vernon Gessford","Boyd Ganus","Edison Redhage","Glenn Voegeli","Carroll Gulati","Tyrell Konopnicki","Brain Fodor","Delmer Amarante","Dee Embertson","Tory Stapelman","Wm Bilder","Cole Brannigan","Gregory Penalosa","Rene Mayo","Vernon Woollard","Zack Bertley","Erich Roszel","Thad Slaby","Ned Willougby","Mose Edlao","Curtis Masloski","Vernon Ansell","Hank Boera","Lucio Pheonix","DeAndre Ornelos","Tobias Soga","Wesley Damboise"];

//MAIN GAME VARIABLES
var myDeck;
var oppDeck;

//initing deck screen
function randAllStats() {
	var avatars = [];
	for(var i = 0; i <31; i++)
		avatars[i] = "art/card_minions/min_"+i+".jpg";
	avatars = shuffle(avatars);
	totalMana = TOTAL_MANA_TO_DISTRIBUTE;
	var borrow = Math.round(Math.random() * 4) - 2;
	var numArr = [];	
	var notLessThanPerCard = 2;

	for(var i = 0; i < Math.floor(TOTAL_CARDS_NUM / 2); i++) {
		var	rVal = Math.round((BASIC_MANA_PER_CARD - notLessThanPerCard) * Math.random());
		numArr[i] = BASIC_MANA_PER_CARD + rVal;
		numArr[TOTAL_CARDS_NUM - i - 1] = BASIC_MANA_PER_CARD - rVal;
	}
	numArr = shuffle(numArr);
	if(namesArr.length > 0)
		namesArr = shuffle(namesArr);

	$(".card_create").each(function(i){		
		var toWork = numArr[i - 1];

		var life = Math.round(toWork * Math.random());
		var attack = toWork - life;
		//TODO: rand extra stuff!!

		setCardProperty(this, "life", life);
		setCardProperty(this, "attack", attack);
		setCardMinionImage(this, avatars[i % avatars.length]);
		if(namesArr.length > 0){
			setCardName(this, namesArr[i % namesArr.length]);
		}

		recalculateCardCost(this);
	});

	totalMana = 0;
	updateManaDisplay();	
}

function tryToUseMana(ammount) {
	if(totalMana - ammount < 0) return false;
	if(totalMana - ammount > TOTAL_MANA_TO_DISTRIBUTE) return false;

	totalMana -= ammount;
	updateManaDisplay();
	return true;
}

function updateManaDisplay() {
	$(".total_mana_points").html(""+totalMana);
}

function recalculateCardCost(card) {
	var life = parseInt($(".life .value", card).html());
	var attack = parseInt($(".attack .value", card).html());
	var costContainer = $(".card_cost", card);

	var upgradeBorder = Math.ceil(BASIC_MANA_PER_CARD);
	var cost = 0;
	if(life < upgradeBorder &&
	   attack < upgradeBorder) {
		cost += Math.floor((life + attack) * 0.5);
	}else {
		if(life < upgradeBorder)
			cost += Math.floor(life * 0.5);
		else
			cost += life;

		if(attack < upgradeBorder)
			cost += Math.floor(attack * 0.5);
		else
			cost += attack;
	}

	costContainer.html(""+cost);
}

function getCardCost(card) {
	return parseInt($(".card_cost", card).html());	
}

function setCardName(card, name) {
	return $(".name", card).html(name);
}

function getCardName(card) {
	return $(".name", card).html();
}

function setCardMinionImage(card, image) {
	$("img.minion", card).attr("src", image);
}

function getCardMinionImage(card) {
	return $("img.minion", card).attr("src");
}

function setCardProperty(card, property, value) {
	$(card).find("."+property+" .value").html(value);
}

function getCardProperty(card, property) {
	return parseInt($(card).find("."+property+" .value").html());
}

function getDeck() {
	var deck = [];
	$(".create_deck .card_container .card_create").each(function(i){		
		deck[i] 
			= {id     : i,
			   life   : getCardProperty(this, "life"),
			   attack : getCardProperty(this, "attack"),
			   name   : getCardName(this),
			   image  : getCardMinionImage(this),
			   cost   : getCardCost(this)};

			   //TODO: add rest
	});	

	return deck;
}

function addToVal(card, name, ammount) {				
	var value = getCardProperty(card, name);	
	console.log("addToVal "+name+" "+ammount+" val: "+value);

	if(value + ammount < 0) return false;
	if(value + ammount > MAX_STAT) return false;

	value += ammount;
	setCardProperty(card, name, value)
	
	return true;
};

function increaseDMG(me){
	if(tryToUseMana(1))						
		if(!addToVal($(me).closest(".card"), "attack", 1))
			tryToUseMana(-1);

	recalculateCardCost($(me).closest(".card"));
}

function decreaseDMG(me){
	if(tryToUseMana(-1)) 						
		if(!addToVal($(me).closest(".card"), "attack", -1))
			tryToUseMana(1);

	recalculateCardCost($(me).closest(".card"));
}

function increaseHP(me){
	if(tryToUseMana(1))						
		if(!addToVal($(me).closest(".card"), "life", 1))
			tryToUseMana(-1);

	recalculateCardCost($(me).closest(".card"));
}

function decreaseHP(me){
	if(tryToUseMana(-1))						
		if(!addToVal($(me).closest(".card"), "life", -1))
			tryToUseMana(1);

	recalculateCardCost($(me).closest(".card"));
}

function inflateCard(container, cardType, cardData) {
	var card = $(".templates ."+cardType).clone();

	setCardName(card, cardData.name);
	setCardMinionImage(card, cardData.image);
	setCardProperty(card, "life", cardData.life);
	setCardProperty(card, "attack", cardData.attack);
	recalculateCardCost(card);

	card.appendTo(container);	
}

//BANNING CARDS

function setLeftToBanNumber(value) {
	$(".left_to_ban").html(value);
}

function getLeftToBan() {
	return parseInt($(".left_to_ban").html());
}

function unBanCard(me) {
	var card = $(me).closest(".card");
	setLeftToBanNumber(getLeftToBan() + 1);

	$(card).css("box-shadow", "none");
	$(card).removeClass("banned");

	$(me).html("Ban");
	$(me).unbind("click");	
	$(me).click(function(){ banCard(me); });
}

function banCard(me) {
	var leftToBan = getLeftToBan();
	if(leftToBan > 0) {
		var card = $(me).closest(".card");
		setLeftToBanNumber(getLeftToBan() - 1);

		$(card).addClass("banned");

		$(me).removeAttr("onclick");
		$(me).html("Un-Ban");
		$(me).unbind("click");
		$(me).click(function(){ unBanCard(me); });	
	}
}

//manage screens
function hideAllScreens() {
	$("div.game .game_screen").each(function(){
		$(this).hide();
	});
}

function inflateCreateDeckScreen() {
	totalMana = TOTAL_MANA_TO_DISTRIBUTE;
	updateManaDisplay();

	$(".game_screen .card_container").html("");
	for(var i = 0; i < TOTAL_CARDS_NUM; i++)
		$(".templates .card_create").clone().appendTo(".game_screen .card_container");
}

function showCreateDeckScreen() {
	hideAllScreens();
	$("div.create_deck").show();	
}

function showWelcomeScreen() {
	hideAllScreens();
	$("div.welcome").show();	
}

function showSearchGame() {
	hideAllScreens();
	$("div.please_wait").show();	
}

function showNonskippableModal(message) {
	$(".modal .content").html(message);
	$(".modal").show();	
	$(".modal").unbind("click");
}

function showSkippableModal(message) {
	$(".modal .content").html(message + '<button onclick="hideModal();">Close</button>');
	$(".modal").show();	
	$(".modal").click(hideModal);
}

function hideModal(){
	$(".modal").hide();
}

function showBanCardsDeck(deck) {
	oppDeck = deck;

	hideAllScreens();
	var cardsContainer = $(".ban_cards .card_container");
	cardsContainer.html("");
	$("div.ban_cards").show();	

	for(var i = 0; i<deck.length; i++)
		inflateCard(cardsContainer, "card_to_ban", deck[i]);	

	setLeftToBanNumber(5);
	$(".isOpponentReady").hide();
}

function showScreenLaunchingGame(){
	hideAllScreens();
	$("div.starting").show();		
}

function readyToPlay(){
	if(getLeftToBan() > 0) {
		alert("You must ban "+getLeftToBan()+" more opponent cards");
		return;
	}

	var bannedCardsPos = [];
	var finOppDeck = [];
	$(".ban_cards .card_container .card")
		.each(function(i){
			if($(this).hasClass("banned")) {
				bannedCardsPos.push(i);				
			} else {
				finOppDeck.push(oppDeck[i]);
			}
		});	

	oppDeck = finOppDeck;

	socket.emit("cardsBanned", bannedCardsPos);	
	showNonskippableModal("<h2>WAITING FOR OPPONENT BANS...</h2>");	
}

function showPlayGameScreen() {
	hideAllScreens();
	$("div.play_game").show();


}

var socket = io();
socket.on("gameStarted", function(deck){	
	showBanCardsDeck(deck);	
});

socket.on("disconnect", function(){
	showCreateDeckScreen();
	alert("Game disconnected :(");
});

socket.on("connectionBroken", function(){
	showCreateDeckScreen();
	alert("Opponent disconnected");
});

socket.on("fireTheActualGame", function(list) {
	var myFinalDeck = [];
	var myBannedCards = [];

	for(var i = 0; i < myDeck.length; i++){
		var banned = false;
		for(var j = 0; j < list.length; j++)
			if(i == list[j]) {
				myBannedCards.push(myDeck[i]);
				banned = true;
				break;
			}
		if(!banned)
			myFinalDeck.push(myDeck[i]);
	}
	myDeck = myFinalDeck;
	
	hideModal();

	showPlayGameScreen();
	showSkippableModal("<div class='con'></div>");

	var message = $(".templates .yourBannedCards").clone();
	var container = $(message).find(".card_container");

	for(var i = 0; i < myBannedCards.length; i++){
		inflateCard(container, "regular_card", myBannedCards[i]);
	}

	$(".modal .con").append(message);
});

function searchForGame() {
	showSearchGame();	

	myDeck = getDeck();	
	socket.emit('searchForGame', myDeck);	
}

hideAllScreens();
showWelcomeScreen();

if(true){
	inflateCreateDeckScreen();
	randAllStats();		

	showCreateDeckScreen();					
}

hideModal();


</script></body>
</html>