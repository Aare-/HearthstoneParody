<!DOCTYPE HTML>
<html>
<head>
	<title>LD31</title>	
	<link href="css/style.css" rel="stylesheet">
	<link href="css/jquery-ui.css" rel="stylesheet">	
	
	<!-- <script src="libs/pixi.js"></script> -->
	<script src="socket.io/socket.io.js"></script>	
	<script src="libs/jquery.min.js"></script>
	<script src="libs/jquery-ui.min.js"></script>
	<script src="libs/name.js"></script>
</head>
<body>
<div class="templates">
	<div class="card card_create">				
		<img class="minion" src=""/>	
		<div class="card_content">	
			<p class="name">_blank_</p>		


			<div class="card_cost">0</div>
			
			<div class="stats">
				<div class="property life">HP: <p class="value">0</p>
					<button class="add" onclick="increaseHP(this);">+</button>
					<button class="remove" onclick="decreaseHP(this);">-</button>
				</div>

				<div class="property attack">DMG: <p class="value">0</p>
				<button class="add" onclick="increaseDMG(this);">+</button>
				<button class="remove" onclick="decreaseDMG(this);">-</button>
				</div>

				<div class="extra death_rattle">
					<div class="list"></div>
					<button>Add death rattle</button>
				</div>

				<div class="extra behavior">
					<div class="list"></div>
					<button>Add behavior</button>
				</div>

				<div class="extra shout">
					<div class="list"></div>
					<button>Add shout</button>
				</div>

				<div class="extra rage">
					<div class="list"></div>
					<button>Add rage</button>
				</div>
			</div>
		</div>		
	</div>

	<div class="card card_to_ban">
		<img class="minion" src=""/>
		<div class="card_content">	
			<p class="name"></p>		

			<button onclick="banCard();">Ban</button>		

			<div class="cost"></div>
			
			<div class="stats">
				<div class="property life">HP: <p class="value"></p></div>
				<div class="property attack">DMG: <p class="value"></p></div>
			</div>
		</div>
	</div>
</div>

<div class="game">
<div class="game_screen welcome">	
		<h1>WELCOE TO HEART_OF_STONE BUT WITH REAL PEOPLE INSTEAD</h1>
		<h2>ALSO YOU CAN PLAY WITH ANY CARDS YOU DESIRE</h2>

		<h3>PREPARING THE GAME...</h3>
	</div>

	<div class="game_screen create_deck">
		<div class="header">
			<h1>Create your deck: </h1>
			<h2>Mana points: <p class="total_mana_points"></p></h2>	
			<button onclick="randAllStats();">Randomise</button>			
			<button onclick="searchForGame();">Play</button>		
		</div>
		<div class="card_container"></div>				
	</div>

	<div class="game_screen please_wait">	
		<h1>SEARCHING FOR OPPONENT!</h1>
	</div>

	<div class="game_screen ban_cards">	
		<div class="header">
			<h1>BAN CARDS!</h1>
			<h2>Left to ban: <p class="value">0</p></h2>
		</div>
		<div class="card_container"></div>
	</div>

	<div class="game_screen play_game">	
	</div>

	<div class="modal">		
		<div class="content"></div>
	</div>
</div>

<script>
//stuff
function shuffle(o){
    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
};

//config
var minionsExtra = 
	[{ name : "death_rattle",
	   arr  : 
			[{id   : "add_lite_opponent", 
			  name : "Add 5 life for opponent", 
			  cost : -2}, 
			 {id   : "change_track_chance", 
			  name : "50% chance to switch track", 			  
			  cost : 1}] 
	 },
	 { name : "behaviour",
	   arr  : 
			[{id   : "double_speed", 
			  name : "Double The Speed", 
			  cost : 2}, 
			 {id   : "change_track_chance", 
			  name : "50% chance to switch track", 
			  chance : 0.5,
			  cost : 1}]
	 },
	 { name : "shout",
	   arr : 
			[{id   : "reverse_order", 
			  name : "Reverse order of ally minions on this track", 
			  cost : 2}, 
			 {id   : "reverse_order_opp", 
			  name : "Reverse order of enemy minions on this track", 		  
			  cost : 2}]
	 },
	 { name : "rage",
	   arr : 
			[{id   : "extra_attack", 
			  name : "Add ", 
			  cost : 2}, 
			 {id   : "heal_line", 
			  name : "If not destroyed heal all ally enemies on track by 2", 		  
			  cost : 2}] }];

var TOTAL_CARDS_NUM = 30;
var BASIC_MANA_PER_CARD = 5;
var TOTAL_MANA_TO_DISTRIBUTE = TOTAL_CARDS_NUM * BASIC_MANA_PER_CARD;
var MAX_STAT = 8;

var totalMana;

var namesArr = [];

//initing deck screen
function randAllStats() {
	var avatars = [];
	for(var i = 0; i <31; i++)
		avatars[i] = "art/card_minions/min_"+i+".jpg";
	avatars = shuffle(avatars);
	totalMana = TOTAL_MANA_TO_DISTRIBUTE;
	var borrow = Math.round(Math.random() * 4) - 2;
	var numArr = [];	
	var notLessThanPerCard = 2;

	for(var i = 0; i < Math.floor(TOTAL_CARDS_NUM / 2); i++) {
		var	rVal = Math.round((BASIC_MANA_PER_CARD - notLessThanPerCard) * Math.random());
		numArr[i] = BASIC_MANA_PER_CARD + rVal;
		numArr[TOTAL_CARDS_NUM - i - 1] = BASIC_MANA_PER_CARD - rVal;
	}
	numArr = shuffle(numArr);
	if(namesArr.length > 0)
		namesArr = shuffle(namesArr);

	$(".card_create").each(function(i){		
		var toWork = numArr[i - 1];

		var life = Math.round(toWork * Math.random());
		var attack = toWork - life;
		//TODO: rand extra stuff!!

		setCardProperty(this, "life", life);
		setCardProperty(this, "attack", attack);
		setCardMinionImage(this, avatars[i % avatars.length]);
		if(namesArr.length > 0){
			setCardName(this, namesArr[i % namesArr.length]);
		}

		recalculateCardCost(this);
	});

	totalMana = 0;
	updateManaDisplay();
}

function showModal(content) {
	(".modal .content").html(content);
	$(".modal").show();	
}

function tryToUseMana(ammount) {
	if(totalMana - ammount < 0) return false;
	if(totalMana - ammount > TOTAL_MANA_TO_DISTRIBUTE) return false;

	totalMana -= ammount;
	updateManaDisplay();
	return true;
}

function updateManaDisplay() {
	$(".total_mana_points").html(""+totalMana);
}

function recalculateCardCost(card) {
	var life = parseInt($(".life .value", card).html());
	var attack = parseInt($(".attack .value", card).html());
	var costContainer = $(".card_cost", card);

	var upgradeBorder = Math.ceil(BASIC_MANA_PER_CARD);
	var cost = 0;
	if(life < upgradeBorder &&
	   attack < upgradeBorder) {
		cost += Math.floor((life + attack) * 0.5);
	}else {
		if(life < upgradeBorder)
			cost += Math.floor(life * 0.5);
		else
			cost += life;

		if(attack < upgradeBorder)
			cost += Math.floor(attack * 0.5);
		else
			cost += attack;
	}

	costContainer.html(""+cost);
}

function getCardCost(card) {
	return parseInt($(".card_cost", card).html());	
}

function setCardName(card, name) {
	return $(".name", card).html(name);
}

function getCardName(card) {
	return $(".name", card).html();
}

function setCardMinionImage(card, image) {
	$("img.minion", card).attr("src", image);
}

function getCardMinionImage(card) {
	return $("img.minion", card).attr("src");
}

function setCardProperty(card, property, value) {
	$(card).find("."+property+" .value").html(value);
}

function getCardProperty(card, property) {
	return parseInt($(card).find("."+property+" .value").html());
}

function getDeck() {
	var deck = [];
	$(".create_deck .card_container .card_create").each(function(i){		
		deck[i] 
			= {life   : getCardProperty(this, "life"),
			   attack : getCardProperty(this, "attack"),
			   cost   : getCardCost(this)};

			   //TODO: add rest
	});	

	return deck;
}

function addToVal(card, name, ammount) {				
	var value = getCardProperty(card, name);	
	console.log("addToVal "+name+" "+ammount+" val: "+value);

	if(value + ammount < 0) return false;
	if(value + ammount > MAX_STAT) return false;

	value += ammount;
	setCardProperty(card, name, value)
	
	return true;
};

function increaseDMG(me){
	if(tryToUseMana(1))						
		if(!addToVal($(me).closest(".card"), "attack", 1))
			tryToUseMana(-1);

	recalculateCardCost($(me).closest(".card"));
}

function decreaseDMG(me){
	if(tryToUseMana(-1)) 						
		if(!addToVal($(me).closest(".card"), "attack", -1))
			tryToUseMana(1);

	recalculateCardCost($(me).closest(".card"));
}

function increaseHP(me){
	if(tryToUseMana(1))						
		if(!addToVal($(me).closest(".card"), "life", 1))
			tryToUseMana(-1);

	recalculateCardCost($(me).closest(".card"));
}

function decreaseHP(me){
	if(tryToUseMana(-1))						
		if(!addToVal($(me).closest(".card"), "life", -1))
			tryToUseMana(1);

	recalculateCardCost($(me).closest(".card"));
}

function addCard(){			
	$(".templates .card_create").clone().appendTo(".game_screen .card_container");			

/*
	for(var i = 0; i < minionsExtra.length; i++) {
		var extra = minionsExtra[i];
		
		var addButton = $(".minion ."+extra.name+" button", card);
		addButton.click(function(){
			showModal("dupa");
		});
		
	}	*/
}

function banCard(){

}

//manage screens
function hideAllScreens() {
	$("div.game .game_screen").each(function(){
		$(this).hide();
	});
}

function inflateCreateDeckScreen() {
	totalMana = TOTAL_MANA_TO_DISTRIBUTE;
	updateManaDisplay();

	$(".game_screen .card_container").html("");
	for(var i = 0; i < TOTAL_CARDS_NUM; i++)
		addCard();
}

function showCreateDeckScreen() {
	hideAllScreens();
	$("div.create_deck").show();	
}

function showWelcomeScreen() {
	hideAllScreens();
	$("div.welcome").show();	
}

function showSearchGame() {
	hideAllScreens();
	$("div.please_wait").show();	
}

function showBanCardsDeck(deck) {
	hideAllScreens();
	var cardsContainer = $(".ban_cards .card_container");
	cardsContainer.html("");
	$("div.ban_cards").show();	

	for(var i = 0; i<deck.length; i++) {
		var cardTemplate = $(".templates .card_to_ban").clone();

		$(".life .value", cardTemplate).html(deck[i].life);
		$(".attack .value", cardTemplate).html(deck[i].attack);
		$(".cost", cardTemplate).html(deck[i].cost);

		cardTemplate.appendTo(cardsContainer);	
	}
}

function showPlayGameScreen() {
	hideAllScreens();
	$("div.play_game").show();


}

var socket = io();
socket.on("gameStarted", function(deck){	
	showBanCardsDeck(deck);
});

function searchForGame() {
	showSearchGame();	

	var deck = getDeck();	

	socket.emit('searchForGame', deck);	
}

hideAllScreens();
showWelcomeScreen();

if(true){
	inflateCreateDeckScreen();
	randAllStats();		

	showCreateDeckScreen();				
}else {
	var boolInited = false;
	for(var j = 0; j < Math.ceil(TOTAL_CARDS_NUM / 5) + 1; j++)
		namey.get({ count: 5, frequency : "rare", type : "male", with_surname : true, callback: 
			function(n) { 
				for(var i = 0; i < n.length; i++)
					namesArr.push(n[i]);			

				if(!boolInited && namesArr.length >= TOTAL_CARDS_NUM) {				
					boolInited = true;
					inflateCreateDeckScreen();
					randAllStats();		

					showCreateDeckScreen();				
				}
			}});
}

</script></body>
</html>